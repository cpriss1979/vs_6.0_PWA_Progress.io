<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  
  <script src="sw-register.js"></script>

  <!-- At the top of delete-account.html <body> or in <head> -->
  <script type="module">
    import './firebase-init.js'; // ensures app/auth/db are initialized
  </script>
    
  <script>
    (function () {
      try {
        var r = document.documentElement;
        var t = localStorage.getItem("themeClass")
          || localStorage.getItem("themeClass:last")
          || "theme-original";
        (r.className.match(/\btheme-[^\s]+/g) || []).forEach(c => r.classList.remove(c));
        r.classList.add(t);
      } catch { }
    })();
  </script>
    
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>3-Sides Planner — REGISTER</title>
  <!-- Absolute (good for GitHub Pages) -->
  <link rel="manifest" href="manifest.webmanifest">
  
  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" sizes="any" href="/3-sides-planner.io/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/3-sides-planner.io/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="3-sides-planner.io/favicon-16.png">
  <link rel="apple-touch-icon" href="/3-sides-planner.io/icon-192.png"> <!-- iOS Home screen -->

  <style>
    /* ====== Page + colors (kept your palette) ====== */
    :root {
      --bg: #030352;
      --purple: #b04bb3;
      --link: #9097de;
      --link-hover: #d39cff;
      --input-bg: #fff;
      --input-text: #000;
      --input-border: #ccc;
      --focus: #e8b8ff;
      --invalid: #ff7aa2;
      --btn-bg: purple;
      --btn-bg-hover: #983d9d;
      --btn-text: #fff;
    }

    html,
    body {
      margin: 0;
      height: 100%
    }

    body {
      font-family: 'Quicksand', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 16px;
    }

    .login-container {
      width: 100%;
      max-width: 320px;
      text-align: center;
    }

    h1 {
      color: var(--purple);
      font-size: 2.5rem;
      margin: 0 0 24px;
    }

    /* ====== Inputs (one consistent size, always) ====== */
    .field {
      display: block;
      width: 100%;
      height: 44px;
      /* <- lock height */
      padding: 12px 14px;
      /* <- lock padding */
      margin: .5rem 0;
      background: var(--input-bg);
      color: var(--input-text);
      border: 1px solid var(--input-border);
      /* <- lock border-width */
      border-radius: 12px;
      box-sizing: border-box;
      /* <- include border in size */
      appearance: none;
      -webkit-appearance: none;
      font: 600 16px/1 'Quicksand', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transition: border-color .15s ease;
    }

    /* Keep the exact same size in every state */
    .field:focus,
    .field:invalid,
    .field:user-invalid,
    .field:-webkit-autofill {
      width: 100%;
      height: 44px;
      padding: 12px 14px;
      border-width: 1px;
      box-sizing: border-box;
    }

    /* Focus ring that doesn't change layout */
    .field:focus {
      outline: 2px solid rgba(232, 184, 255, .55);
      outline-offset: 0;
      border-color: var(--focus);
      box-shadow: none;
    }

    /* Invalid look: only change color, not size */
    .field:invalid,
    .field:user-invalid {
      border-color: var(--invalid);
      outline: none;
      box-shadow: none;
    }

    /* Firefox special invalid glow off */
    .field:-moz-ui-invalid {
      box-shadow: none;
    }

    /* Autofill keep colors sane */
    .field:-webkit-autofill {
      -webkit-text-fill-color: var(--input-text);
      box-shadow: 0 0 0 1000px var(--input-bg) inset !important;
      transition: background-color 9999s ease-out;
    }

    /* Button */
    button {
      width: 100%;
      height: 44px;
      display: block;
      margin: 12px 0 8px;
      border: 0;
      border-radius: 8px;
      background: var(--btn-bg);
      color: var(--btn-text);
      font: 700 16px/1 'Quicksand', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      cursor: pointer;
      transition: background .2s ease;
      touch-action: manipulation;
    }

    button:hover {
      background: var(--btn-bg-hover);
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    /* Message line (fixed height so layout doesn't jump) */
    #msg {
      min-height: 24px;
      /* ~1.5rem */
      font-size: .95rem;
      color: #fff;
    }

    /* Links below */
    .auth-links {
      color: #fff;
      margin-top: 8px;
    }

    .auth-links a {
      color: var(--link);
      font-weight: 700;
      text-decoration: none;
    }

    .auth-links a:hover {
      color: var(--link-hover);
      text-decoration: underline;
    }

    .backToApp {
      display: inline-block;
      margin-top: 6px;
      color: rgb(201, 108, 201);
      text-decoration: none;
      font-size: 1.25rem;
    }

    @media (max-width:600px) {
      body {
        padding: 0 12px;
      }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <h1>Register</h1>

    <input id="name" class="field" type="text" placeholder="Display name (optional)" autocomplete="name" />
    <input id="email" class="field" type="email" placeholder="Email (required)" autocomplete="email" />
    <input id="pass" class="field" type="password" placeholder="Password (required)" autocomplete="new-password" />
    <button id="registerBtn" disabled>Register</button>
    <div id="msg"></div>

    <p class="auth-links">Already have an account? <a id="loginLink" href="login.html">Login here</a></p>
    <a class="backToApp" href="index.html">← Back to App</a>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import {
      setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, updateProfile, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const isEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

    document.addEventListener("DOMContentLoaded", async () => {
      await setPersistence(auth, browserLocalPersistence);

      const nameEl = $("name");
      const emailEl = $("email");
      const passEl = $("pass");
      const btn = $("registerBtn");
      const msg = $("msg");

      // Carry ?next= to the login page too
      const qsNext = new URLSearchParams(location.search).get("next");
      const loginLink = $("loginLink");
      if (loginLink && qsNext) loginLink.href = `login.html?next=${encodeURIComponent(qsNext)}`;

      const valid = () => isEmail(emailEl.value.trim()) && passEl.value.length >= 6;

      const showEmailHint = () => {
        const email = emailEl.value.trim();
        if (!email) { msg.textContent = ""; return; }
        if (!isEmail(email)) {
          msg.textContent = email.includes("@")
            ? "Enter a valid email (e.g., name@example.com)."
            : "Usernames without '@' aren't supported — please use your email address (e.g., name@example.com).";
        } else { msg.textContent = ""; }
      };

      const showPassHint = () => {
        const n = passEl.value.length;
        if (n > 0 && n < 6) {
          msg.textContent = "Password must be at least 6 characters.";
        } else if (isEmail(emailEl.value.trim())) {
          msg.textContent = "";
        }
      };

      const sync = () => {
        btn.disabled = !valid();
      };

      emailEl.addEventListener("input", () => { sync(); if (msg.textContent) showEmailHint(); });
      emailEl.addEventListener("blur", showEmailHint);

      passEl.addEventListener("input", () => { sync(); showPassHint(); });
      passEl.addEventListener("blur", showPassHint);

      [nameEl, emailEl, passEl].forEach(el => el.addEventListener("keydown", e => {
        if (e.key === "Enter") btn.click();
      }));

      sync();

      btn.addEventListener("click", async (e) => {
        e.preventDefault();

        if (!valid()) {
          // Re-run hints so the user sees why
          showEmailHint();
          showPassHint();
          return;
        }

        msg.textContent = "Creating account…";
        btn.disabled = true;

        try {
          const cred = await createUserWithEmailAndPassword(
            auth,
            emailEl.value.trim(),
            passEl.value
          );

          const displayName = nameEl.value.trim();
          if (displayName) {
            try { await updateProfile(cred.user, { displayName }); } catch { }
          }

          await setDoc(doc(db, "users", cred.user.uid), { themeClass: "theme-original" }, { merge: true });

          const dest = qsNext || sessionStorage.getItem("postLoginRedirect") || "index.html";
          sessionStorage.removeItem("postLoginRedirect");
          location.assign(dest);
        } catch (err) {
          console.error(err);
          msg.textContent = err.code || err.message;
          btn.disabled = false;
        }
      });

      onAuthStateChanged(auth, (u) => {
        console.log("[register] user:", u ? u.uid : "(none)");
      });
    });
  </script>
</body>

</html>