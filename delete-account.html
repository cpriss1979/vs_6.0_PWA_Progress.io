<!DOCTYPE html>
<html lang="en">

<head>
    <!-- At the top of delete-account.html <body> or in <head> -->
    <script type="module">
        import './firebase-init.js'; // ensures app/auth/db are initialized
    </script>
        
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Delete Account & Data — 3 Sides Planner</title>

    <style>
        :root {
            color-scheme: light;
        }

        body {
            font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            padding: 24px;
            background: #f7f7fb;
            color: #111;
        }

        .danger-card {
            max-width: 720px;
            margin: 24px auto;
            padding: 20px 22px;
            border: 1px solid #eee;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 8px 28px rgba(0, 0, 0, .06)
        }

        .danger-card h1 {
            margin: .25rem 0 1rem;
            font-size: 1.5rem
        }

        .danger {
            color: #b00020;
            font-weight: 700
        }

        .muted {
            color: #555
        }

        .field {
            margin: .9rem 0
        }

        .field input {
            width: 100%;
            padding: .75rem .85rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem
        }

        .row {
            display: flex;
            gap: .8rem;
            flex-wrap: wrap;
            margin-top: .9rem
        }

        button {
            cursor: pointer;
            border: 0;
            border-radius: 12px;
            padding: .75rem 1rem;
            font-weight: 600
        }

        .btn-secondary {
            background: #efefef
        }

        .btn-danger {
            background: #b00020;
            color: #fff
        }

        .btn-danger:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .status {
            margin-top: 1rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            color: #2a5
        }

        .status.error {
            color: #b00020
        }

        .progress {
            margin-top: .5rem;
            font-size: .92rem;
            color: #333;
            white-space: pre-wrap;
            background: #fafafa;
            border: 1px dashed #e5e5e5;
            border-radius: 10px;
            padding: .75rem
        }

        .hint {
            font-size: .92rem;
            color: #444;
            background: #fff7f7;
            border: 1px solid #fde2e2;
            border-radius: 12px;
            padding: .75rem;
            margin-top: 1rem
        }
    </style>
</head>

<body>
    <div class="danger-card">
        <h1>Delete Account & Data</h1>
        <p class="muted">
            This will permanently delete your account (email/password) and remove your data:
            Journal, Toolkit, Wellness (plan, letter, support people), Pet, and Themes.
            It will also clear local data on this device and sign you out.
        </p>
        <p class="danger">This cannot be undone.</p>

        <div class="field">
            <label class="muted">Type <b>DELETE</b> to confirm:</label>
            <input id="confirmText" placeholder="DELETE" autocomplete="off" />
        </div>

        <div id="reauthBlock" class="field" style="display:none">
            <p class="muted"><b>Re-authentication required.</b> Please confirm your identity to continue.</p>
            <input id="reauthEmail" placeholder="Email" autocomplete="username" />
            <input id="reauthPass" type="password" placeholder="Password" autocomplete="current-password"
                style="margin-top:.5rem" />
            <div class="row">
                <button class="btn-secondary" id="reauthPassword">Re-auth with Password</button>
                <button class="btn-secondary" id="reauthGoogle">Re-auth with Google</button>
            </div>
            <div class="hint">If your account was created with Google sign-in, use “Re-auth with Google”.</div>
        </div>

        <div class="row">
            <button class="btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn-danger" id="deleteBtn" disabled>Delete my account & data</button>
        </div>

        <div id="status" class="status" style="display:none"></div>
        <div id="progress" class="progress" style="display:none"></div>
    </div>

    <script type="module">
        // Requires your firebase-init.js to export { auth, db } (Firebase v9+ modular)
        import { auth, db } from './firebase-init.js';
        import {
            EmailAuthProvider,
            GoogleAuthProvider,
            reauthenticateWithCredential,
            reauthenticateWithPopup,
            deleteUser,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import {
            doc, deleteDoc, collection, getDocs, query
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // ---- UI helpers
        const $ = (id) => document.getElementById(id);
        const confirmText = $('confirmText');
        const deleteBtn = $('deleteBtn');
        const cancelBtn = $('cancelBtn');
        const statusBox = $('status');
        const progressBox = $('progress');
        const reauthBlock = $('reauthBlock');
        const reauthEmail = $('reauthEmail');
        const reauthPass = $('reauthPass');
        const reauthPasswordBtn = $('reauthPassword');
        const reauthGoogleBtn = $('reauthGoogle');

        confirmText.addEventListener('input', () => {
            deleteBtn.disabled = (confirmText.value.trim().toUpperCase() !== 'DELETE');
        });

        cancelBtn.addEventListener('click', () => {
            window.history.length > 1 ? history.back() : (location.href = 'index.html');
        });

        function setStatus(msg, isError = false) {
            statusBox.style.display = 'block';
            statusBox.textContent = msg;
            statusBox.classList.toggle('error', isError);
        }
        function logStep(msg) {
            progressBox.style.display = 'block';
            progressBox.textContent += `• ${msg}\n`;
        }

        // ---- Adjust if your structure differs
        // Known subcollections under users/{uid}
        const SUBCOLLECTIONS = [
            'journalEntries',
            'toolkit',
            'wellness',          // e.g., plan, letter, support people
            'pet',
            'themes'
        ];

        async function deleteSubcollection(uid, name) {
            const ref = collection(db, 'users', uid, name);
            const snap = await getDocs(query(ref));
            let count = 0;
            for (const d of snap.docs) {
                await deleteDoc(d.ref);
                count++;
                if (count % 50 === 0) logStep(`Deleted ${count} docs in ${name}…`);
            }
            logStep(`Deleted ${count} docs in ${name}`);
        }

        async function deleteAllUserData(uid) {
            // Delete subcollections first
            for (const sub of SUBCOLLECTIONS) {
                try { await deleteSubcollection(uid, sub); }
                catch (e) { logStep(`(warn) ${sub}: ${e.message}`); }
            }
            // Delete root user doc last
            try {
                await deleteDoc(doc(db, 'users', uid));
                logStep('Deleted root user document');
            } catch (e) {
                logStep(`(warn) root doc: ${e.message}`);
            }
        }

        async function clearLocalDeviceData() {
            // Storage
            try { localStorage.clear(); } catch { }
            try { sessionStorage.clear(); } catch { }
            logStep('Cleared local & session storage');

            // IndexedDB (add your custom DB names here if needed)
            const dbsToDelete = [
                'firebaseLocalStorageDb',
                'firebase-messaging-database',
                'app-db',
                'workbox-expiration'
            ];
            for (const name of dbsToDelete) {
                try { await indexedDB.deleteDatabase(name); logStep(`Deleted IndexedDB: ${name}`); } catch { }
            }

            // SW caches
            if (window.caches) {
                try {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(k => caches.delete(k)));
                    logStep('Cleared service worker caches');
                } catch { }
            }

            // Push + SW unregister
            try {
                const regs = await navigator.serviceWorker?.getRegistrations?.();
                if (regs && regs.length) {
                    for (const r of regs) {
                        try {
                            const sub = await r.pushManager.getSubscription();
                            if (sub) { await sub.unsubscribe(); }
                            await r.unregister();
                        } catch { }
                    }
                    logStep('Unsubscribed push & unregistered service workers');
                }
            } catch { }
        }

        async function reauthWithPassword(user) {
            const email = reauthEmail.value.trim() || user.email || '';
            const pass = reauthPass.value;
            const cred = EmailAuthProvider.credential(email, pass);
            await reauthenticateWithCredential(user, cred);
        }
        async function reauthWithGoogle(user) {
            await reauthenticateWithPopup(user, new GoogleAuthProvider());
        }

        function showReauthUI(prefillEmail) {
            reauthBlock.style.display = 'block';
            reauthEmail.value = prefillEmail || '';
            setStatus('Please re-authenticate to continue deletion.', true);
        }

        deleteBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) { setStatus('You are not signed in.', true); return; }

            deleteBtn.disabled = true;
            statusBox.style.display = 'none';
            progressBox.textContent = '';
            progressBox.style.display = 'none';
            setStatus('Starting account deletion…');

            const tryDeleteFlow = async () => {
                logStep('Deleting cloud data (Firestore)…');
                await deleteAllUserData(user.uid);

                logStep('Deleting Firebase Auth account…');
                await deleteUser(user);

                logStep('Clearing data on this device…');
                await clearLocalDeviceData();

                setStatus('Your account and data have been permanently deleted. 💛');
                setTimeout(() => { location.href = 'index.html'; }, 1400);
            };

            try {
                await tryDeleteFlow();
            } catch (err) {
                const needsReauth = String(err?.code || err?.message || '').includes('requires-recent-login');
                if (!needsReauth) {
                    setStatus(`Deletion failed: ${err?.message || err}`, true);
                    deleteBtn.disabled = false;
                    return;
                }

                // Ask user to re-auth, then retry
                showReauthUI(user.email || '');
                const doPw = () => reauthWithPassword(user);
                const doGoogle = () => reauthWithGoogle(user);

                const onPw = async () => {
                    try {
                        await doPw();
                        setStatus('Re-authentication successful. Continuing…');
                        reauthPasswordBtn.disabled = true;
                        reauthGoogleBtn.disabled = true;
                        await tryDeleteFlow();
                    } catch (e) {
                        setStatus(`Re-auth failed: ${e.message}`, true);
                        reauthPasswordBtn.disabled = false;
                        reauthGoogleBtn.disabled = false;
                    }
                };
                const onGo = async () => {
                    try {
                        await doGoogle();
                        setStatus('Re-authentication successful. Continuing…');
                        reauthPasswordBtn.disabled = true;
                        reauthGoogleBtn.disabled = true;
                        await tryDeleteFlow();
                    } catch (e) {
                        setStatus(`Re-auth failed: ${e.message}`, true);
                        reauthPasswordBtn.disabled = false;
                        reauthGoogleBtn.disabled = false;
                    }
                };

                reauthPasswordBtn.onclick = onPw;
                reauthGoogleBtn.onclick = onGo;
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                setStatus('Sign in to delete your account.', true);
                deleteBtn.disabled = true;
            }
        });
    </script>
</body>

</html>